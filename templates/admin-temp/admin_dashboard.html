{% load static %}
<!DOCTYPE html>
<html lang="en" class="bg-[#FAF9F6] text-slate-900 font-serif min-h-screen">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-[#FAF9F6] text-slate-900 antialiased">
    <header
      class="bg-[#2C3E50] shadow-md p-6 flex justify-between items-center sticky top-0 z-50 border-b border-[#1F2A38] text-[#EAE2B7]"
    >
      <h1 class="text-3xl font-semibold tracking-wide">
        ðŸŽ“ Counseling Dashboard
      </h1>
      <a
        href="{% url 'admin:index' %}"
        class="bg-[#117A65] hover:bg-[#0E6655] focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#148F77] text-[#FDFEFE] font-medium px-5 py-2 rounded-md shadow-sm transition duration-200"
      >
        Admin Home
      </a>
    </header>

    <main class="p-10 max-w-7xl mx-auto space-y-12">
      <!-- Stats -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-10">
        <div
          class="bg-[#F7F4EA] border border-[#C2B280] rounded-lg p-8 text-center shadow-sm hover:shadow-md transition-shadow duration-300"
        >
          <h2 class="text-xl font-semibold mb-3 tracking-wide text-[#34495E]">
            Total Students
          </h2>
          <p class="text-4xl font-bold text-[#2874A6] tracking-widest">
            {{ total_students }}
          </p>
        </div>
        <div
          class="bg-[#F7F4EA] border border-[#C2B280] rounded-lg p-8 text-center shadow-sm hover:shadow-md transition-shadow duration-300"
        >
          <h2 class="text-xl font-semibold mb-3 tracking-wide text-[#34495E]">
            Allotted
          </h2>
          <p class="text-4xl font-bold text-[#1ABC9C] tracking-widest">
            {{ allotted }}
          </p>
        </div>
        <div
          class="bg-[#F7F4EA] border border-[#C2B280] rounded-lg p-8 text-center shadow-sm hover:shadow-md transition-shadow duration-300"
        >
          <h2 class="text-xl font-semibold mb-3 tracking-wide text-[#34495E]">
            Pending
          </h2>
          <p class="text-4xl font-bold text-[#C0392B] tracking-widest">
            {{ not_allotted }}
          </p>
        </div>
      </section>

      <!-- Actions and Search -->
      <section
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 border-b border-[#C2B280] pb-6"
      >
        <form
          method="POST"
          action="{% url 'mass_allocation' %}"
          class="flex items-center gap-4"
        >
          {% csrf_token %}
          <input type="hidden" name="student_ids" id="mass_ids" />
          <button
            type="submit"
            class="bg-[#117A65] hover:bg-[#0E6655] focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#148F77] text-[#FDFEFE] font-semibold px-6 py-2 rounded-md shadow-sm transition duration-200"
          >
            Mass Allocate
          </button>
        </form>

        <input
          type="search"
          id="searchInput"
          placeholder="Search students..."
          class="p-3 rounded-md w-full md:w-80 text-slate-900 font-medium placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#2874A6]"
          aria-label="Search students"
        />
      </section>

      <!-- Student Fee Management Table -->
      <section
        class="overflow-x-auto rounded-lg shadow-lg border border-[#C2B280] bg-[#FEFDFC]"
      >
        <table class="min-w-full text-sm border-collapse">
          <thead class="bg-[#EAE2B7] border-b border-[#C2B280]">
            <tr>
              <th class="p-3 text-left">
                <input
                  type="checkbox"
                  id="selectAll"
                  class="cursor-pointer"
                  aria-label="Select all students"
                />
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Name
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Branch
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Rank
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                12th Percentage
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Allotted
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Fees Paid
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Fee Receipt
              </th>
              <th
                class="p-3 text-left font-semibold tracking-wide text-[#34495E]"
              >
                Action
              </th>
            </tr>
          </thead>
          <tbody id="studentTable">
            {% for student in students %}
            <tr
              class="odd:bg-[#FCFAF6] even:bg-[#F4EEE1] hover:bg-[#D6EAF8] transition-colors duration-200"
            >
              <td class="p-3">
                <input
                  type="checkbox"
                  class="selectRow cursor-pointer"
                  value="{{ student.id }}"
                  aria-label="Select student {{ student.user.username }}"
                />
              </td>
              <td class="p-3 font-medium text-[#2C3E50]">
                {{ student.user.username }}
              </td>
              <td class="p-3 text-[#2C3E50]">{{ student.allotted_branch }}</td>
              <td class="p-3 text-[#2C3E50]">{{ student.rank }}</td>
              <td class="p-3 text-[#2C3E50]">{{ student.Percentage_12 }}</td>
              <td class="p-3 text-[#2C3E50]">
                {{ student.is_allotted|yesno:"Yes,No" }}
              </td>
              <td class="p-3 text-[#2C3E50]">{{ student.fee_paid }}</td>
              <td>
                {% if student.fee_receipt %}
                <a
                  href="{{ student.fee_receipt.url }}"
                  target="_blank"
                  class="bg-blue-600 text-white px-3 py-1 rounded-md"
                >
                  View Receipt
                </a>
                {% else %}
                <span class="text-gray-500">No receipt uploaded</span>
                {% endif %}
              </td>
              <td class="p-3 whitespace-nowrap">
                {% if student.fee_paid != "YES" %}
                <form
                  method="POST"
                  action="{% url 'mark_fees_paid' student.id %}"
                >
                  {% csrf_token %}
                  <button
                    type="submit"
                    class="bg-[#2874A6] hover:bg-[#1B4F72] focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#4D90FE] text-white font-semibold px-5 py-1 rounded-md shadow-sm transition duration-200"
                  >
                    Mark as Paid
                  </button>
                </form>
                {% else %}
                <button
                  type="button"
                  disabled
                  class="bg-[#A9A9A9] text-[#34495E] px-5 py-1 rounded-md cursor-not-allowed font-semibold shadow-sm"
                >
                  âœ” Paid
                </button>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td
                colspan="7"
                class="p-6 text-center text-[#7F8C8D] font-semibold tracking-wide"
              >
                No students found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>

    <script>
      // Select/Deselect all checkboxes
      document
        .getElementById("selectAll")
        .addEventListener("change", function () {
          document
            .querySelectorAll(".selectRow")
            .forEach((cb) => (cb.checked = this.checked));
        });

      // Update hidden input with selected student IDs before mass allocation submit
      function updateSelectedIds() {
        const selectedIds = Array.from(
          document.querySelectorAll(".selectRow:checked")
        ).map((cb) => cb.value);
        const massInput = document.getElementById("mass_ids");
        if (massInput) massInput.value = selectedIds.join(",");
      }

      const massForm = document.querySelector(
        'form[action="{% url "mass_allocation" %}"]'
      );
      if (massForm) {
        massForm.addEventListener("submit", (e) => {
          updateSelectedIds();
          if (!document.getElementById("mass_ids").value) {
            e.preventDefault();
            alert("Please select at least one student for mass allocation.");
          }
        });
      }

      // Search filter
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          const filter = this.value.toLowerCase();
          document.querySelectorAll("#studentTable tr").forEach((row) => {
            row.style.display = row.innerText.toLowerCase().includes(filter)
              ? ""
              : "none";
          });
        });
    </script>
  </body>
</html>
